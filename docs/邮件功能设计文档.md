# 邮件功能设计文档

## 1. 概述

本文档详细描述行政助手系统中邮件附件下载和邮件阅读功能的设计方案，旨在提供灵活、高效、安全的邮件内容获取能力。

## 2. 功能需求

### 2.1 邮件附件下载功能

- **日期范围过滤**：

  - 支持通过 start_date 和 end_date 参数指定日期范围（格式：YYYY-MM-DD）
  - 可以只指定开始日期或结束日期，形成半开放式日期范围
- **文件类型过滤**：

  - 支持通过 file_extensions 参数指定要下载的文件扩展名列表
  - 支持常见文档格式（如 pdf、doc、docx、xls、xlsx、ppt、pptx、txt 等）
  - 支持图像格式（如 jpg、jpeg、png、gif、bmp 等）
  - 支持压缩格式（如 zip、rar、7z 等）
- **附件处理**：

  - 支持下载标准附件
  - 支持可选下载内联附件
  - 支持从邮件正文提取链接并下载链接中的文件
  - 提供文件名冲突处理机制，避免覆盖已存在文件
  - 支持文件大小限制，避免下载超大文件

### 2.2 邮件阅读功能

- **邮件列表获取**：

  - 支持通过 start_date 和 end_date 参数指定日期范围
  - 支持指定邮箱文件夹
  - 支持限制返回邮件数量
- **邮件内容展示**：

  - 显示邮件主题、发件人、收件人、日期
  - 显示附件信息（是否有附件、附件列表）
  - 支持可选包含邮件正文（纯文本和HTML转文本）
  - 对长正文提供预览功能，避免输出过长

## 3. 数据流程设计

### 3.1 附件下载流程

1. **配置验证**：验证邮箱服务器配置和参数有效性
2. **连接服务器**：通过IMAP协议连接到指定邮箱服务器
3. **邮件搜索**：根据日期参数构建搜索条件，筛选目标邮件
4. **邮件处理**：遍历匹配的邮件，处理每封邮件中的附件
5. **附件过滤**：根据文件扩展名过滤需要下载的附件
6. **文件保存**：将附件保存到指定目录，处理文件名冲突
7. **结果返回**：返回下载统计信息

### 3.2 邮件阅读流程

1. **配置验证**：验证邮箱服务器配置和参数有效性
2. **连接服务器**：通过IMAP协议连接到指定邮箱服务器
3. **邮件搜索**：根据日期和文件夹参数搜索邮件
4. **邮件获取**：获取指定数量的邮件详细信息
5. **内容提取**：解析邮件头、正文和附件信息
6. **结果格式化**：将邮件信息格式化为用户友好的输出

## 4. API设计

### 4.1 download_emails 工具

**描述**：下载指定日期范围内的邮件附件

**输入参数**：

```json
{
  "imap_server": "string",          // IMAP服务器地址
  "username": "string",             // 邮箱用户名
  "password": "string",             // 邮箱密码或授权码
  "save_dir": "string",             // 保存附件的目录路径
  "start_date": "2023-01-01",       // 起始日期，格式 YYYY-MM-DD
  "end_date": "2023-01-31",         // 结束日期，格式 YYYY-MM-DD（含当日）
  "file_extensions": ["pdf", "doc"], // 要下载的文件扩展名列表，为None时下载所有附件
  "include_inline": false,           // 是否下载内联附件，默认为false
  "download_from_body": false        // 是否从邮件正文链接下载，默认为false
}
```

**输出**：

```json
{
  "type": "text",
  "text": "成功下载 10 个最近7天的附件到目录: /path/to/attachments"
}
```

### 4.2 read_emails 工具

**描述**：根据日期范围读取邮件内容

**输入参数**：

```json
{
  "imap_server": "string",          // IMAP服务器地址
  "username": "string",             // 邮箱用户名
  "password": "string",             // 邮箱密码或授权码

  "start_date": "2023-01-01",       // 起始日期，格式 YYYY-MM-DD
  "end_date": "2023-01-31",         // 结束日期，格式 YYYY-MM-DD（含当日）
  "max_emails": 50,                  // 最大读取邮件数量，默认为50封
  "include_body": true,              // 是否包含邮件正文，默认为true
  "folder": "INBOX"                 // 邮箱文件夹，默认为INBOX
}
```

**输出**：

```json
{
  "type": "text",
  "text": "📧 邮件阅读结果 (最近7天)\n\n共找到 15 封邮件，成功读取 15 封\n\n=== 邮件 1 ===\n📧 主题: 会议通知\n👤 发件人: user@example.com\n📅 日期: Wed, 01 Jan 2023 10:00:00 +0800\n📎 附件: 是\n📁 附件列表: 会议议程.docx, 参会人员.xlsx\n📝 正文预览: 各位同事，下周一上午10点将举行季度总结会议，请准时参加...\n"
}
```

## 5. 实现细节

### 5.1 EmailAttachmentDownloader 类设计

核心功能类，负责所有邮件相关操作，主要方法包括：

- **初始化与配置**：

  - 从配置文件读取默认设置
  - 支持传入参数覆盖默认配置
  - 配置有效性验证
- **连接管理**：

  - 安全连接到IMAP服务器
  - 会话状态维护
  - 错误处理和自动重连机制（可选）
- **邮件搜索**：

  - 灵活的日期过滤机制
  - 支持精准日期搜索和范围搜索
  - 多条件组合搜索
- **附件处理**：

  - 附件识别和类型判断
  - 文件扩展名过滤
  - 文件名安全处理（避免特殊字符问题）
  - 文件冲突处理（重命名机制）
- **内容提取**：

  - 邮件头信息解析
  - 正文提取和格式转换（HTML到纯文本）
  - 附件列表提取

### 5.2 日期处理机制

- **日期格式标准化**：

  - 支持字符串格式：YYYY-MM-DD
  - 支持datetime对象
  - 支持date对象
- **日期搜索机制**：

  - 仅支持通过start_date和end_date参数指定日期范围
  - 支持半开放式日期范围搜索（只指定开始或结束日期）
  - 日期格式必须为YYYY-MM-DD

### 5.3 文件类型处理

- **扩展名规范化**：

  - 转小写处理，避免大小写问题
  - 去除前导点，统一格式
- **常见文件类型分组**：

  - 文档：pdf, doc, docx, xls, xlsx, ppt, pptx, txt, csv, rtf
  - 图像：jpg, jpeg, png, gif, bmp, tiff, webp
  - 压缩包：zip, rar, 7z, tar, gz
  - 音频：mp3, wav, aac, flac
  - 视频：mp4, avi, mkv, mov

## 6. 安全性考虑

### 6.1 密码保护

- 避免在日志中记录密码和授权码
- 考虑提供环境变量或安全存储选项
- 确保内存中密码处理安全

### 6.2 输入验证

- 严格验证邮箱服务器配置
- 验证日期格式有效性
- 验证保存路径权限和存在性

### 6.3 错误处理

- 全面的异常捕获机制
- 提供有意义的错误信息
- 避免敏感信息泄露

### 6.4 性能与资源管理

- 邮件数量限制，避免内存溢出
- 大型附件处理策略
- 连接自动关闭，避免资源泄漏

## 7. 扩展性考虑

### 7.1 功能扩展点

- 支持SMTP发送邮件功能
- 邮件分类和标记功能
- 邮件内容分析和摘要
- 定期自动下载功能

### 7.2 支持多邮箱提供商

- 针对不同邮箱服务的特殊处理
- 配置模板支持
- 适配器模式设计，便于扩展新的邮件服务

## 8. 输入输出示例

### 8.1 邮件附件下载示例

**输入**：

```json
{
  "imap_server": "imap.example.com",
  "username": "user@example.com",
  "password": "password123",
  "save_dir": "/tmp/attachments",
  "start_date": "2023-10-01",
  "end_date": "2023-10-31",
  "file_extensions": ["pdf", "docx"]
}
```

**输出**：

```
成功下载 5 个日期范围 2023-10-01 至 2023-10-31 的附件到目录: /tmp/attachments
```

### 8.2 邮件阅读示例

**输入**：

```json
{
  "imap_server": "imap.example.com",
  "username": "user@example.com",
  "password": "password123",
  "days_ago": 3,
  "max_emails": 10,
  "include_body": true
}
```

**输出**：

```
📧 邮件阅读结果 (最近3天)

共找到 8 封邮件，成功读取 8 封

=== 邮件 1 ===
📧 主题: 项目进度报告
👤 发件人: project@example.com
📅 日期: Fri, 27 Oct 2023 14:30:00 +0800
📎 附件: 是
📁 附件列表: 进度表.xlsx, 分析报告.pdf
📝 正文预览: 尊敬的团队成员，附件是本周项目进度报告，请查收并提供反馈...

=== 邮件 2 ===
📧 主题: 会议纪要
👤 发件人: meeting@example.com
📅 日期: Thu, 26 Oct 2023 16:45:00 +0800
📎 附件: 否
📝 正文预览: 以下是今天上午会议的纪要，请各位确认：1. 讨论了Q4目标...
```

## 9. 总结

本文档详细设计了行政助手系统中的邮件附件下载和邮件阅读功能，提供了灵活的日期过滤和文件类型过滤机制，确保功能实用、高效和安全。设计充分考虑了扩展性和用户体验，为后续功能增强打下基础。
